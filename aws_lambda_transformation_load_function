import json
import os
from geopy.geocoders import Nominatim
from functools import partial
import geopy
from geopy.extra.rate_limiter import RateLimiter
from datetime import datetime
from opencage.geocoder import OpenCageGeocode
from pprint import pprint
import boto3
import pandas as pd
from io import StringIO
import time


geo_key = os.environ.get('geo_key')
geolocator = Nominatim(user_agent="geocode_beautiful_locations_from_the_world")
geocode = RateLimiter(geolocator.geocode, min_delay_seconds=2, max_retries=8)
geocoder = OpenCageGeocode(geo_key)

def most_beautiful(data):
    
    most_beautiful_list = []
    
    for i in range(20):
        
        # GETTING RAW DATA
        try:
            location_description = geocoder.geocode(data[i])
        except Exception:
            print(str(i) + " " + "No data found for location: " + data[i])
            continue
        
        # GETTING ADDRESS VALUES
        latitude = str(location_description[0]['geometry']['lat'])
        longitude = str(location_description[0]['geometry']['lng'])
        loc_title = data[i].split(",")[0]

        
        try:
            city = location_description[0]['components']['city']
        except Exception:
            try:
                city = location_description[0]['components']['town']
            except Exception:
                try:
                    city = location_description[0]['components']['state']
                except Exception:
                    city = "NULL"
                    
        country = location_description[0]['components']['country']
        country_code = location_description[0]['components']['country_code']
        continent = location_description[0]['components']['continent']
        
        # GETTING POSTCODE
        lat_long = str(latitude) + ","+ str(longitude) 
        location2 = geolocator.reverse(lat_long, language="en")
        try:
            postcode = location2.raw['address']['postcode'].replace(" ","")
        except:
            postcode = "NULL"
            
            
        # ADDING VARIABLES TO DICTIONARY & LISTS
        address_dict = {'Location': loc_title, 'City/State': city, 'Country': country, 'Country Code':country_code.upper(), 'Continent': continent, 'Latitude': str(round(float(latitude),2)), 'Longitude': str(round(float(longitude),2)), 'Postcode': postcode}
        most_beautiful_list.append(address_dict)
    
    return most_beautiful_list



def most_haunted(data):
    
    most_haunted_list = []
    for i in range(20):
        
        # SEPERATING TITLE AND LOCATION
        title_list = []
        location_list = []
        counter = 0
        place_list = []
        
        place_list = data[i].strip().split(" ")
        for x in range(len(place_list)):
            if place_list[x] == "in":
                counter = 1
                continue
            elif place_list[x] != "in" and counter < 1:
                title_list.append(place_list[x])
            elif place_list[x] != "in" and counter == 1:
                location_list.append(place_list[x])
        seperator = " "
        title = seperator.join(title_list)
        location = seperator.join(location_list)
        
        # GETTING RAW DATA
        try:
            location_description = geocoder.geocode(location)
        except Exception:
            print(str(i) + " " + "No data found for location: " + location)
            continue
        
        # GETTING ADDRESS VALUES
        try:
            city = location_description[0]['components']['city']
        except Exception:
            try:
                city = location_description[0]['components']['town']
            except Exception:
                try:
                    city = location_description[0]['components']['state']
                except Exception:
                    city = "NULL"
        country = location_description[0]['components']['country']
        country_code = location_description[0]['components']['country_code']
        continent = location_description[0]['components']['continent']
        latitude = str(location_description[0]['geometry']['lat'])
        longitude = str(location_description[0]['geometry']['lng'])
        
        #GETTING POSTCODE
        lat_long = str(latitude) + ","+ str(longitude) 
        location2 = geolocator.reverse(lat_long, language="en")
        try:
            postcode = location2.raw['address']['postcode'].replace(" ","")
        except:
            postcode = "NULL"
        
        # ADDING VARIABLES TO DICTIONARY
        #print(str(i) +"  "+ title + "  " + city +"  " + country + "  " + country_code.upper() + "  " + continent + "  " + latitude + "  "+ longitude+ "  " + postcode + "\n")
        address_dict = {'Location': title, 'City/State': city, 'Country': country, 'Country Code':country_code.upper(), 'Continent': continent, 'Latitude': str(round(float(latitude),2)), 'Longitude': str(round(float(longitude),2)), 'Postcode': postcode}
        most_haunted_list.append(address_dict)

    return most_haunted_list


def most_religious(data):
    
    most_religious_list = []
    
    for i in range(21):
        
        # GETTING RAW DATA
        try:
            location_description = geocoder.geocode(data[i])
        except Exception:
            print(str(i) + " " + "No data found for location: " + data[i])
            continue
        
        # GETTING ADDRESS VALUES
        loc_title = data[i].split(",")[0]
        latitude = str(location_description[0]['geometry']['lat'])
        longitude = str(location_description[0]['geometry']['lng'])
        try:
            city = location_description[0]['components']['city']
        except Exception:
            try:
                city = location_description[0]['components']['town']
            except Exception:
                try:
                    city = location_description[0]['components']['state']
                except Exception:
                    city = "NULL"
        country = location_description[0]['components']['country']
        country_code = location_description[0]['components']['country_code']
        continent = location_description[0]['components']['continent']
        visitors = data[i+21]
        
        #GETTING POSTCODE
        lat_long = str(latitude) + ","+ str(longitude) 
        location2 = geolocator.reverse(lat_long, language="en")
        try:
            postcode = location2.raw['address']['postcode'].replace(" ","")
        except:
            postcode = "NULL"
            
        # ADDING VARIABLES TO DICTIONARY
        address_dict = {'Location': loc_title, 'City/State': city, 'Country': country, 'Country Code':country_code.upper(), 'Continent': continent, 'Latitude': str(round(float(latitude),2)), 'Longitude': str(round(float(longitude),2)), 'Postcode': postcode, 'Visitors (in Millions)': visitors}
        most_religious_list.append(address_dict)
    
    return most_religious_list

def most_toured(data):
    
    most_toured_list = []
    
    for i in range(int(len(data)/2)):
        
        # GETTING RAW DATA
        try:
         location_description = geocoder.geocode(data[i])
        except Exception:
         print(str(i) + " " + "No data found for location: " + str(data[i]))
         continue
        
        # GETTING ADDRESS COMPONENTS
        city = data[i]
        country = location_description[0]['components']['country']
        country_code = location_description[0]['components']['country_code']
        continent = location_description[0]['components']['continent']
        latitude = str(location_description[0]['geometry']['lat'])
        longitude = str(location_description[0]['geometry']['lng'])
        visitors = data[i+20].split(" ")[0]
        
        #GETTING POSTCODE
        lat_long = str(latitude) + ","+ str(longitude) 
        location2 = geolocator.reverse(lat_long, language="en")
        try:
         postcode = location2.raw['address']['postcode'].replace(" ","")
        except:
         postcode = "NULL"
        
        # ADDING VARIABLES TO DICTIONARY
        #print(str(i) +"  "+ city +"  " + country + "  " + country_code.upper() + "  " + continent + "  " + latitude + "  "+ longitude+ "  " + postcode + "  " + visitors)
        address_dict = {'City': city, 'Country': country, 'Country Code':country_code.upper(), 'Continent': continent, 'Latitude': str(round(float(latitude),2)), 'Longitude': str(round(float(longitude),2)), 'Postcode': postcode, 'Visitors (in Millions)': visitors}
        most_toured_list.append(address_dict)

    return most_toured_list


def most_expensive(data):
    
    most_expensive_list = []
    
    for i in range(20):
        
        # GETTING RAW DATA
        try:
            location_description = geocoder.geocode(data[i])
        except Exception:
            print(str(i) + " " + "No data found for location: " + data[i])
            continue
        
        # GETTING ADDRESS VALUES
        latitude = str(location_description[0]['geometry']['lat'])
        longitude = str(location_description[0]['geometry']['lng'])
        city = data[i]
        country = location_description[0]['components']['country']
        country_code = location_description[0]['components']['country_code']
        continent = location_description[0]['components']['continent']
        
        #GETTING POSTCODE
        lat_long = str(latitude) + ","+ str(longitude) 
        location2 = geolocator.reverse(lat_long, language="en")
        try:
            postcode = location2.raw['address']['postcode'].replace(" ","")
        except:
            postcode = "NULL"
            
            
        # ADDING VARIABLES TO DICTIONARY
        #print(str(i) +"  "+ city +"  " + country + "  " + country_code.upper() + "  " + continent + "  " + latitude + "  "+ longitude+ "  " + postcode)
        address_dict = {'City': city, 'Country': country, 'Country Code':country_code.upper(), 'Continent': continent, 'Latitude': str(round(float(latitude),2)), 'Longitude': str(round(float(longitude),2)), 'Postcode': postcode}
        most_expensive_list.append(address_dict)
    
    return most_expensive_list



def lambda_handler(event, context):
    
    s3 = boto3.client('s3')
    bucket = "geolocation-etl-project"
    key = "raw_data/to-be-processed/"
    
    geocode_keys = []
    for file in (s3.list_objects(Bucket = bucket, Prefix = key)['Contents']):
        file_key = file['Key']
        
        if file_key.split(".")[-1] == "json":
            response = s3.get_object(Bucket = bucket, Key = file_key)
            content = response['Body']
            jsonObject = json.loads(content.read())
            geocode_keys.append(file_key)
            
            if "most_beautiful" in file_key:
                most_beautiful_list = most_beautiful(jsonObject)
                most_beautiful_df = pd.DataFrame.from_dict(most_beautiful_list)
                
                most_beautiful_key = "transformed_data/most_beautiful/most_beautiful_places_" + str(datetime.now()) + ".csv"
                most_beautiful_buffer = StringIO()
                most_beautiful_df.to_csv(most_beautiful_buffer, index=False)
                most_beautiful_content = most_beautiful_buffer.getvalue()
                try:
                    s3.put_object(Bucket = bucket, Key = most_beautiful_key, Body = most_beautiful_content)
                    print("Transformed Data uploaded to S3 successfully.")
                except:
                    print("Transformed Data upload to S3 failed.")
                time.sleep(2)
                
            elif "most_expensive" in file_key:
                most_expensive_list = most_expensive(jsonObject)
                most_expensive_df = pd.DataFrame.from_dict(most_expensive_list)
                
                most_expensive_key = "transformed_data/most_expensive/most_expensive_places_" + str(datetime.now()) + ".csv"
                most_expensive_buffer = StringIO()
                most_expensive_df.to_csv(most_expensive_buffer, index=False)
                most_expensive_content = most_expensive_buffer.getvalue()
                try:
                    s3.put_object(Bucket = bucket, Key = most_expensive_key, Body = most_expensive_content)
                    print("Transformed Data uploaded to S3 successfully.")
                except:
                    print("Transformed Data upload to S3 failed.")
                time.sleep(2)
            
            elif "most_haunted" in file_key:
                most_haunted_list = most_haunted(jsonObject)
                most_haunted_df = pd.DataFrame.from_dict(most_haunted_list)
                
                most_haunted_key = "transformed_data/most_haunted/most_haunted_places_" + str(datetime.now()) + ".csv"
                most_haunted_buffer = StringIO()
                most_haunted_df.to_csv(most_haunted_buffer, index=False)
                most_haunted_content = most_haunted_buffer.getvalue()
                try:
                    s3.put_object(Bucket = bucket, Key = most_haunted_key, Body = most_haunted_content)
                    print("Transformed Data uploaded to S3 successfully.")
                except:
                    print("Transformed Data upload to S3 failed.")
                time.sleep(2)
            
            elif "most_religious" in file_key:
                most_religious_list = most_religious(jsonObject)
                most_religious_df = pd.DataFrame.from_dict(most_religious_list)
                
                most_religious_key = "transformed_data/most_religious/most_religious_places_" + str(datetime.now()) + ".csv"
                most_religious_buffer = StringIO()
                most_religious_df.to_csv(most_religious_buffer, index=False)
                most_religious_content = most_religious_buffer.getvalue()
                try:
                    s3.put_object(Bucket = bucket, Key = most_religious_key, Body = most_religious_content)
                    print("Transformed Data uploaded to S3 successfully.")
                except:
                    print("Transformed Data upload to S3 failed.")
                time.sleep(2)
            
            
            elif "most_toured" in file_key:
                most_toured_list = most_toured(jsonObject)
                most_toured_df = pd.DataFrame.from_dict(most_toured_list)
                
                most_toured_key = "transformed_data/most_tourist/most_toured_places_" + str(datetime.now()) + ".csv"
                most_toured_buffer = StringIO()
                most_toured_df.to_csv(most_toured_buffer, index=False)
                most_toured_content = most_toured_buffer.getvalue()
                try:
                    s3.put_object(Bucket = bucket, Key = most_toured_key, Body = most_toured_content)
                    print("Transformed Data uploaded to S3 successfully.")
                except:
                    print("Transformed Data upload to S3 failed.")
                time.sleep(2)
            
            else:
                print("This data file doesn't match any given template: " + file_key)
    
    s3_resource = boto3.resource('s3')
    for key in geocode_keys:
        copy_source = {
            "Bucket" : bucket,
            "Key" : key
        }
        s3_resource.meta.client.copy(copy_source, bucket, 'raw_data/processed/'+ key.split('/')[-1])
        s3_resource.Object(bucket,key).delete()
    
